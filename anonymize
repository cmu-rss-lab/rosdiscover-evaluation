#!/bin/bash
#
# This script attempts to anonymize a given replication package
#
set -eu

INPUT="$1"
HERE_DIR=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )
REPO_ROOT="${HERE_DIR}"
OUTPUT_FILENAME="${REPO_ROOT}/anonymous-replication-package.zip"

#
if [ -f "${OUTPUT_FILENAME}" ]; then
  echo "removing existing anonymized replication package: ${OUTPUT_FILENAME}"
  rm "${OUTPUT_FILENAME}"
fi

# extract to a temporary directory
TEMP_DIR=$(mktemp -d)

echo "* unpacking replication package into temporary anonymization directory: ${TEMP_DIR}"
unzip "${INPUT}" -d "${TEMP_DIR}"
pushd "${TEMP_DIR}"

echo "* Redacting identification ..."
find . -type f -print | xargs -n1 -I@ sed -i "s#github.com/ChrisTimperley#REDACTED#g" "@"
find . -type f -print | xargs -n1 -I@ sed -i "s#github.com/squaresLab#REDACTED#g" "@"
find . -type f -print | xargs -n1 -I@ sed -i "s#github.com/rosqual#REDACTED#g" "@"
find . -type f -print | xargs -n1 -I@ sed -i "s#ChrisTimperley#REDACTED#g" "@"
find . -type f -print | xargs -n1 -I@ sed -i "s#christimperley.co.uk#REDACTED#g" "@"
find . -type f -print | xargs -n1 -I@ sed -i "s#christimperley@googlemail.com#REDACTED#g" "@"
find . -type f -print | xargs -n1 -I@ sed -i "s#christimperley#REDACTED#g" "@"
find . -type f -print | xargs -n1 -I@ sed -i "s#Christopher S. Timperley#REDACTED#g" "@"
find . -type f -print | xargs -n1 -I@ sed -i "s#Christopher Steven Timperley#REDACTED#g" "@"
find . -type f -print | xargs -n1 -I@ sed -i "s#Christopher Timperley#REDACTED#g" "@"
find . -type f -print | xargs -n1 -I@ sed -i "s#/home/chris#REDACTED#g" "@"

echo "* moving results files ..."
cp -r experiments/* results
chmod -R +w results
# separate recovery
for i in $(ls results/recovery/subjects/); do
  # remove experiment from results
  results_dir="results/recovery/subjects/$i"
  #rm -r $results_dir/logs/*
  rm -f $results_dir/experiment*.yml
  rm -f $results_dir/pkgs.rosinstall
  rm -f $results_dir/bug.rosinstall
  rm -f $results_dir/fix.rosinstall
  rm -f $results_dir/Docker-reproduce*
  rm -rf $results_dir/docker
  # remove the results stuff from the experiments
  dir="experiments/recovery/subjects/$i"
  rm -rf $dir/models/*
  for f in $(ls $dir/); do
    if test -f "$results_dir/$f"; then
      rm "$dir/$f"
    fi
  done
done

#separate detection
for i in $(ls results/detection/subjects/); do
  # remove experiment from results
  results_dir="results/detection/subjects/$i"
  rm -f $results_dir/experiment*.yml
  rm -f $results_dir/pkgs.rosinstall
  rm -f $results_dir/bug.rosinstall
  rm -f $results_dir/fix.rosinstall
  rm -f $results_dir/Docker-reproduce*
  rm -f $results_dir/Dockerfile-reproduce*
  rm -rf $results_dir/docker
  # remove the results stuff from the experiments
  dir="experiments/detection/subjects/$i"
  rm -rf $dir/models/*
  for f in $(ls $dir/); do
    if test -f "$results_dir/$f"; then
      rm "$dir/$f"
    fi
  done
done


echo "* zipping anonymized directory..."
zip -r "${OUTPUT_FILENAME}" \
  architecture-style \
  deps \
  docker \
  experiments \
  results \
  rootfs \
  scripts \
  .dockerignore \
  Pipfile \
  Pipfile.lock \
  README.rst \
  Dockerfile-autoware
popd
echo "* destroying temporary directory..."
rm -rf "${TEMP_DIR}"
